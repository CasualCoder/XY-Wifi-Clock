<html>
<head>
    <title>Wifi Clock</title>
    <style>
    body { font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }
    label { width:110px; display: inline-block; }
	th { font-weight: bold; }
	td { text-align: center; }
	button { cursor: pointer; background-color: #e1ecf4; border-radius: 3px; color: #2c5777; border: 1px solid #7aa7c7; box-sizing: border-box; padding: 8px 12px; }
    </style>
	<script>
	function checkBrowserSupported() {
		"use strict";

		try { eval("var foo = (x)=>x+1"); }
		catch (e) { return false; }
		return true;
	}

	if (!checkBrowserSupported()) {
		alert("Your browser is outdated and unfortunately is not supported.");
	}
	</script>
</head>
<body>
    <h1>Wifi Clock</h1>
    <form>
        <label>Device Name</label><input type="text" id="deviceName" name="deviceName" maxlength="15"/><br/><br/>
        <label>Timezone</label><select id="timezone" name="timezone">
            <option value="UTC">Coordinated Universal Time</option>
            <option value="WET">Western European Time (UTC DST)</option>
			<option value="WAT">West Africa Time (UTC+1)</option>
            <option value="CET">Central European Time (UTC+1 DST)</option>
			<option value="CAT">Central Africa Time (UTC+2)</option>
            <option value="EET">Eastern European Time (UTC+2 DST)</option>
            <option value="MSK">Moscow Time (UTC+3)</option>
            <option value="IRT">Iran Time (UTC+3:30)</option>
            <option value="SAMT">Samara Time (UTC+4)</option>
            <option value="AFT">Afghanistan Time (UTC+4:30)</option>
            <option value="PAT">Pakistan Time (UTC+5)</option>
            <option value="IST">India Time (UTC+5:30)</option>
            <option value="NST">Nepal Time (UTC+5:45)</option>
            <option value="BST">Bangladesh Time (UTC+6)</option>
            <option value="MMT">Myanmar Time (UTC+6:30)</option>
            <option value="ICT">Indochina Time (UTC+7)</option>
            <option value="CST">China/Australian Western Time (UTC+8)</option>
			<option value="AWCST">Australian Western Central Time (UTC+8:45)</option>
            <option value="JST">Japan/Korea Time (UTC+9)</option>
            <option value="ACST">Australian Central Time (UTC+9:30)</option>
            <option value="ACDT">Australian Central Time (UTC+9:30 DST)</option>
            <option value="AEST">Australian Eastern Time (UTC+10)</option>
            <option value="AEDT">Australian Eastern Time (UTC+10 DST)</option>
            <option value="MAGT">Magadan Time (UTC+11)</option>
            <option value="PETT">Kamchatka Time (UTC+12)</option>
            <option value="NZST">New Zealand Time (UTC+12 DST)</option>
            <option value="NZCST">New Zealand Chatham Time (UTC+13:45 DST)</option>
            <option value="KST">Kiribati Time (UTC+14)</option>
            <option value="SST">Somoa Time (UTC-11)</option>
            <option value="SST">Hawaiiâ€“Aleutian Time (UTC-10)</option>
            <option value="AKST">Alaska Time (UTC-10 DST)</option>
            <option value="FPMST">French Polynesia Marquesas Islands Time (UTC-9:30)</option>
            <option value="FPGST">French Polynesia Gambier Islands Time (UTC-9)</option>
            <option value="UKPT">UK Pitcairn Islands Time (UTC-8)</option>
            <option value="PST">Pacific Time (UTC-8 DST)</option>
            <option value="AZT">Arizona Time (UTC-7)</option>
            <option value="MST">Mountain Time (UTC-7 DST)</option>
            <option value="SKST">Saskatchewan Time (UTC-6)</option>
            <option value="CST">Central Time (UTC-6 DST)</option>
            <option value="CAST">Caribbean/Nunavut Time (UTC-5)</option>
            <option value="EST">Eastern Time (UTC-5 DST)</option>
            <option value="ECST">Eastern Caribbean Time (UTC-4)</option>
			<option value="AST">Atlantic Time (UTC-4 DST)</option>
			<option value="NFT">Newfoundland Time (UTC-3:30 DST)</option>
			<option value="BRT">Brasilia Time (UTC-3)</option>
			<option value="WGT">West Greenland Time (UTC-3 DST)</option>
			<option value="EGT">East Greenland Time (UTC-2 DST)</option>
			<option value="PAIT">Portugal Azores Islands Time (UTC-1 DST)</option>
        </select><br/><br/>
		
		<table id="alarms-table" style="width:360px">
			<thead>
				<tr>
					<th>Hour</th>
					<th>Min</th>
					<th>Mon</th>
					<th>Tue</th>
					<th>Wed</th>
					<th>Thu</th>
					<th>Fri</th>
					<th>Sat</th>
					<th>Sun</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><select class="hour"></select></td>
					<td><select class="minute"></select></td>
					<td><input  class="mon" type="checkbox"></td>
					<td><input  class="tue" type="checkbox"></td>
					<td><input  class="wed" type="checkbox"></td>
					<td><input  class="thu" type="checkbox"></td>
					<td><input  class="fri" type="checkbox"></td>
					<td><input  class="sat" type="checkbox"></td>
					<td><input  class="sun" type="checkbox"></td>
				</tr>
			</tbody>
		</table>
		<br/>
		<div style="width:360px; text-align: center">
			<button id="save" type="button">Save</button>
		</div>
    </form>
	
<script type="application/javascript">

var alarmRowTemplate = document.querySelector("#alarms-table tbody tr");

function mockConfigFetch() {
  return Promise.resolve({
		json: () => Promise.resolve({ deviceName: "XY-Clock", timezone: "BST", alarms: [
			{ hour: 7, minute: 40, daysOfWeek: [true, true, true, true, true, false, false] },
			{ hour: 8, minute: 00, daysOfWeek: [false, false, false, false, false, true, true] }
		]}),
  })
}

function loadConfig() {
	fetch("/config")
	//mockConfigFetch()
	.then(response => response.json())
	.then(config => displayConfig(config));
}

function displayConfig(config) {
	document.getElementById("deviceName").value = config.deviceName;
	document.getElementById("timezone").value = config.timezone;
	
	if (!config.alarms) return;
	
	for (var i=0; i < config.alarms.length; i++) {
		var alarm = config.alarms[i];
		
		var tr = document.querySelectorAll("#alarms-table tbody tr")[i];
		
		tr.querySelector(".hour").value = alarm.hour;
		tr.querySelector(".minute").value = alarm.minute;
		tr.querySelector(".mon").checked = alarm.daysOfWeek[0];
		tr.querySelector(".tue").checked = alarm.daysOfWeek[1];
		tr.querySelector(".wed").checked = alarm.daysOfWeek[2];
		tr.querySelector(".thu").checked = alarm.daysOfWeek[3];
		tr.querySelector(".fri").checked = alarm.daysOfWeek[4];
		tr.querySelector(".sat").checked = alarm.daysOfWeek[5];
		tr.querySelector(".sun").checked = alarm.daysOfWeek[6];
	}
}

function getConfigFromForm() {
	data = {
		deviceName: document.getElementById("deviceName").value,
		timezone: document.getElementById("timezone").value,
		alarms: []
	};
	
	var trs = document.querySelectorAll("#alarms-table tbody tr");
	
	for (var i=0; i < trs.length; i++) {
		var tr = trs[i];
		var alarm = {
			hour: parseInt(tr.querySelector(".hour").value),
			minute: parseInt(tr.querySelector(".minute").value),
			daysOfWeek: [false, false, false, false, false, false, false]
		};
		
		alarm.daysOfWeek[0] = tr.querySelector(".mon").checked;
		alarm.daysOfWeek[1] = tr.querySelector(".tue").checked;
		alarm.daysOfWeek[2] = tr.querySelector(".wed").checked;
		alarm.daysOfWeek[3] = tr.querySelector(".thu").checked;
		alarm.daysOfWeek[4] = tr.querySelector(".fri").checked;
		alarm.daysOfWeek[5] = tr.querySelector(".sat").checked;
		alarm.daysOfWeek[6] = tr.querySelector(".sun").checked;
		
		data.alarms.push(alarm);
	}
	
	return data;
}

function saveConfig() {
	var data = getConfigFromForm();
	var json = JSON.stringify(data);
	
	document.getElementById("save").innerHTML = "Saving...";
	
	return fetch("/config", {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: json
	})
	.then(() => document.getElementById("save").innerHTML = "Save");
}

function populateHours() {
	var select = alarmRowTemplate.querySelector(".hour");
	
	for (var i=0; i < 24; i++) {
		var option = document.createElement("option");
		option.value = i;
		option.text = new String(i);
		if (option.text.length == 1) option.text = "0" + option.text;
		
		select.add(option);
	}
}

function populateMinutes() {
	var select = alarmRowTemplate.querySelector(".minute");
	
	for (var i=0; i < 60; i+=1) {
		var option = document.createElement("option");
		option.value = i;
		option.text = new String(i);
		if (option.text.length == 1) option.text = "0" + option.text;
		
		select.add(option);
	}
}

function populateAlarmLookups() {
	populateHours();
	populateMinutes();
}

function setupAlarms() {
	populateAlarmLookups();
	
	var rowsToAdd = 5;
	var tableBody = document.querySelector("#alarms-table tbody");
	
	for (var i=0; i < rowsToAdd; i++) {
		var alarmRow = alarmRowTemplate.cloneNode(true);
		
		tableBody.appendChild(alarmRow)
	}
}

function setupSave() {
	var saveButton = document.getElementById("save");
	saveButton.addEventListener("click", saveConfig);
}

addEventListener("load", (event) => {
	setupAlarms();
	loadConfig();
	setupSave();
});

</script>
</body>
</html>
